XIAOMI.namespace("goodsDetail"),
XIAOMI.Util = {
	SLIDE_INDEX: 0,
	pageScrollToSpot: function(a) {
		if ("object" != typeof a) return ! 1;
		var b = a.offset().top - 60;
		$("html,body").animate({
			scrollTop: b + "px"
		},
		500)
	},
	dotmpl: function(a, b) {
		var c = a.html(),
		d = doT.template(c);
		return d(b)
	},
	jsonP: function(a, b) {
		$.ajax({
			type: "GET",
			url: a.url,
			dataType: "jsonp",
			jsonp: "jsonpcallback",
			success: function(c) {
				b(c, a)
			}
		})
	},
	isIE6: function() {
		return !! window.ActiveXObject && !window.XMLHttpRequest
	},
	imgLoad: function(a, b) {
		var c = new Image;
		c.src = a,
		c.complete ? b() : c.onload = function() {
			b(),
			c.onload = null
		}
	}
},
XIAOMI.goodsDetail = {
	init: function() {
		var a = this;
		a.config(),
		a.runMultiFuns()
	},
	config: function() {
		var a = this;
		a.u = XIAOMI.Util,
		a.comment_options = {
			pageAmount: 5,
			orderBy: 1,
			pageNum: 1,
			comment_grade: 0,
			ProductId: goodsConfig.ProductId
		},
		a.bigpicFlag = !1,
		"function" != typeof String.prototype.trim && (String.prototype.trim = function() {
			return this.replace(/^\s+|\s+$/g, "")
		})
	},
	runMultiFuns: function() {
		var a = this;
		a.showHeadView(),
		a.showProSlide(),
		a.btnClickToSpot(),
		a.locationToM(),
		a.setHistoryList(),
		a.saveHistoryList(),
		a.showStoreBtnStatus(),
		a.changeStoreBtnStatus(),
		a.showGuessUlike(),
		a.addShopCart(),
		a.showCommentlist(),
		a.clickChangeOrder(),
		a.initQuestionList(),
		a.generateQuestion(),
		a.commonQuesModal(),
		a.isUseFul(),
		a.judgeClothSize(),
		a.clickBigPic()
	},
	showHeadView: function() {
		$(window).scroll(function() {
			var a = $(this).scrollTop(),
			b = $("#goodsDetail").offset().top + 50;
			if (a > b) {
				$("#goodsSubBar").addClass("goods-sub-bar-play"),
				$("#goodsSubMenu").find("li").eq(0).addClass("current").siblings().removeClass("current");
				var c = $("#goodsSubMenu > ul > li:gt(0)").length;
				$("#goodsSubMenu > ul > li:gt(0)").each(function() {
					var b = $(this).find("a").attr("href");
					b && (itemSt = $(b).offset().top - 70, nextItem = null, nextItem = $(this).index() < c ? $(this).next().find("a").attr("href") : $(".guess-u-like"), nextItemSt = $(nextItem).offset().top, a > itemSt && nextItemSt > a && $(this).addClass("current").siblings().removeClass("current"))
				})
			} else $("#goodsSubBar").removeClass("goods-sub-bar-play")
		})
	},
	changeProSlidCallback: function(a) {
		var b = this,
		c = null;
		c = $("#goodsPicList").find("li").eq(a).find("img").attr(b.bigpicFlag ? "data-src-b": "data-src");
		var d = $("#goodsPicList").find("li").eq(a).find("img").attr("data-src-b"),
		e = function() {
			$(".J_goodsBigPic").attr("src", c)
		},
		f = function() {
			$(".J_goodsBigPic").attr("srcset", d)
		};
		b.u.imgLoad(c, e),
		b.u.imgLoad(d, f),
		$("#goodsPicList").find("li").removeClass("current"),
		$("#goodsPicList").find("li").eq(a).addClass("current")
	},
	showProSlide: function() {
		var a = this,
		b = a.u;
		b.SLIDE_INDEX = 0,
		$(document).on("click", "#goodsPicList>li",
		function() {
			var c = $(this).index();
			a.changeProSlidCallback(c),
			b.SLIDE_INDEX = c
		});
		var c = $("#goodsPicList").find("li").length;
		$(document).on("click", "#goodsPicPrev",
		function() {
			var d = b.SLIDE_INDEX - 1;
			0 > d && (d = c - 1),
			b.SLIDE_INDEX = d,
			a.changeProSlidCallback(d)
		}),
		$(document).on("click", "#goodsPicNext",
		function() {
			var d = b.SLIDE_INDEX + 1;
			d > c - 1 && (d = 0),
			b.SLIDE_INDEX = d,
			a.changeProSlidCallback(d)
		})
	},
	btnClickToSpot: function() {
		var a = this,
		b = a.u;
		$(".J_pro_related_btns").find("a").each(function() {
			$(this).click(function() {
				var a = $(this).attr("href"),
				c = $(a);
				b.pageScrollToSpot(c)
			})
		})
	},
	locationToM: function() {
		
	},
	setHistoryList: function() {
		var a = XIAOMI.app.History(),
		b = this.u,
		c = $("#history-tmpl"),
		d = b.dotmpl(c, a);
		$("#goodsRectScan").html(d)
	},
	saveHistoryList: function() {
		var a = $("#goodsPicList > li").eq(0).find("img").attr("src"),
		b = $("#goodsName").html(),
		c = $(".J_mi_goodsPrice").html();
		b = $.trim(b),
		c = $.trim(c);
		var d = goodsConfig.GoodsId,
		e = $(".J_mi_goods_starNum").attr("data-class"),
		f = a + "," + b + "," + c + "," + d + "," + e,
		g = XIAOMI.app.cookie("XM_scan_history");
		if (g) {
			var h = g.split("#m#"),
			i = $.inArray(f, h);
			i > -1 && h.splice(i, 1),
			h.length > 6 && h.pop(),
			g = f + "#m#" + h.join("#m#")
		} else g = f + "#m#";
		XIAOMI.app.cookie("XM_scan_history", g, {
			path: "/",
			domain: ".mi.com"
		})
	},
	callback_Store: function(a, b) {
		var c = this;
		if (1 === a.code) $("#goodsDetailCollectBtn").attr("data-isfavorite", "true").removeClass("btn-dake").addClass("btn-yellow"),
		"del" === b.btype && $("#goodsDetailCollectBtn").attr("data-isfavorite", "false").removeClass("btn-yellow").addClass("btn-dake");
		else if ( - 1 === a.code) alert(a.message);
		else if ( - 2 === a.code) if (XIAOMI.app.cookie("userId")) {
			var d = XIAOMI.GLOBAL_CONFIG.orderSite + "/user/proxy/stop/1",
			e = "<iframe src='" + d + "' width='0' height='0' name='proxy' id='proxy' frameborder='0' scrolling='no'></iframe>";
			$(document.body).append(e),
			$("iframe[name='proxy']").load(function() {
				$("iframe[name='proxy']").remove(),
				c.u.jsonP(b, $.proxy(c.callback_Store, c))
			})
		} else {
			var f = new XIAOMI.app.miniLogin;
			f.autoExec()
		}
	},
	showStoreBtnStatus: function() {
		var a = XIAOMI.app.cookie("userId"),
		b = this;
		if (a) {
			var c = {};
			c.url = XIAOMI.GLOBAL_CONFIG.orderSite + "/favorite/check/id/" + goodsConfig.GoodsId,
			b.u.jsonP(c, $.proxy(b.callback_Store, b))
		}
	},
	changeStoreBtnStatus: function() {
		var a = this,
		b = {};
		$("#goodsDetailCollectBtn").click(function() {
			var c = $(this).attr("data-isfavorite");
			"true" === c ? (b.btype = "del", b.url = XIAOMI.GLOBAL_CONFIG.orderSite + "/favorite/drop/id/" + goodsConfig.GoodsId, a.u.jsonP(b, $.proxy(a.callback_Store, a))) : (b.url = XIAOMI.GLOBAL_CONFIG.orderSite + "/favorite/add/id/" + goodsConfig.GoodsId, b.btype = "add", a.u.jsonP(b, $.proxy(a.callback_Store, a)))
		})
	},
	showGuessUlike: function() {
		var a = this;
		XIAOMI.app.setRecommend({
			obj: $("#guess-u-like-box"),
			tmpl: $("#guessUlike-tmpl"),
			url: XIAOMI.GLOBAL_CONFIG.sideBarApiUrl + "/guesslike/get/id/" + goodsConfig.GoodsId + "/callback/itemRecommend/cid/2",
			max: 3,
			callback: function() {
				a.goodsAlsoBuy()
			}
		})
	},
	addShopCart: function() {
		XIAOMI.app.addShopCartEvent({
			obj: "#goodsDetailAddCartBtn",
			callback: function(a, b) {
				if (b.attr("data-disabled", "false"), 1 === a.code) {
					var c = $("<img>"),
					d = b.offset().top - 166,
					e = b.offset().left,
					f = $("#J_miniCart").offset().top + 20,
					g = $("#J_miniCart").offset().left + 60,
					h = $("#goodsPicList").find("li").eq(0).find("img").attr("src");
					c.css({
						display: "block",
						width: "160px",
						height: "160px",
						position: "absolute",
						top: d,
						left: e,
						"z-index": "1000",
						border: "2px solid #f60"
					}).attr("src", h),
					c.appendTo("body").animate({
						top: f,
						left: g,
						width: "20px",
						height: "20px"
					},
					400, "linear",
					function() {
						$(this).remove()
					})
				} else alert(a.message)
			}
		}),
		XIAOMI.app.addShopCartEvent({
			obj: "#goodsSubBarAddCartBtn",
			callback: function(a, b) {
				if (b.attr("data-disabled", "false"), 1 === a.code) {
					b.parent().css({
						position: "relative",
						overflow: "hidden"
					});
					var c = $("<span>");
					c.html("<i class='icon-goods-add-success'></i>加入成功！").appendTo(b.parent()).addClass("item-action-state").animate({
						top: "10px"
					},
					200,
					function() {
						{
							var a = $(this);
							setTimeout(function() {
								a.animate({
									top: "52px"
								},
								200,
								function() {
									$(this).remove()
								})
							},
							1e3)
						}
					})
				} else alert(a.message)
			}
		})
	},
	showCommentlist: function() {
		var a = this,
		b = a.comment_options,
		c = $("#J_goods_detail_comment"),
		d = $("#comment-tmpl"),
		e = function(b) {
			if (0 === b.errorno) {
				var e = b.data,
				f = a.u.dotmpl(d, e);
				c.html(f),
				a.u.isIE6() && $(".site-footer").css("padding-top", "1px")
			}
		},
		f = jiangpeiKey.closeGoodsCommentList;
		f ? (c.html("<br><p style='text-align:center;'>抢购活动期间，服务器压力山大，评价暂时停止显示</p>"), $(".J_comment_order").remove()) : XIAOMI.goodsComments.showCommentList(b, e)
	},
	clickChangeOrder: function() {
		var a = this,
		b = a.comment_options,
		c = $("#J_goods_detail_comment"),
		d = $("#comment-tmpl"),
		e = function(b) {
			if (0 === b.errorno) {
				var e = b.data,
				f = a.u.dotmpl(d, e);
				c.html(f)
			}
		};
		$(".J_comment_order").find(".item").click(function() {
			$(this).siblings(".item").removeClass("active"),
			$(this).addClass("active");
			var a = $(this).attr("data-order");
			b.orderBy = a,
			XIAOMI.goodsComments.showCommentList(b, e)
		})
	},
	initQuestionList: function() {
		var a = function(a) {
			var b = $("#question-tmpl"),
			c = a.comments;
			0 == c.length && $(".J_question_all_link").hide();
			var d = XIAOMI.goodsComments.dotmpl(b, c);
			$(".J_mi_question").html(d)
		},
		b = {
			ProductId: goodsConfig.ProductId,
			pageIndex: 1,
			pagesize: 5
		};
		XIAOMI.goodsComments.getQuestionList(b, a)
	},
	revertStr: function(a) {
		return String(a).replace(/&(?!\w+;)/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;")
	},
	generateQuestion: function() {
		var a = this;
		$(".J_mi_ask").click(function() {
			var b = $(".J_mi_ask_content").val();
			if ("" === b) return alert("内容不能为空"),
			!1;
			if (b.length > 140) return alert("字数不能超过140"),
			!1;
			b = XIAOMI.goodsComments.revertStr(b);
			var c = {
				content: b,
				ProductId: goodsConfig.ProductId
			},
			d = 0,
			e = function(b) {
				if (0 === b.code) b.data && (1 == b.data.comment_status ? (alert("提交成功，并且审核通过"), a.initQuestionList()) : alert("提交成功，请等待审核"), $(".J_mi_ask_content").val(""));
				else if ( - 1001 == b.code) if (XIAOMI.app.cookie("userId")) {
					var f = XIAOMI.GLOBAL_CONFIG.askApiUrl + "/user/proxy/stop/1",
					g = "<iframe src='" + f + "' width='0' height='0' name='proxy' id='proxy' frameborder='0' scrolling='no'></iframe>";
					$(document.body).append(g),
					$("iframe[name='proxy']").load(function() {
						$("iframe[name='proxy']").remove(),
						d++,
						1 == d && XIAOMI.goodsComments.askQuestion(c, $.proxy(e, a))
					})
				} else {
					var h = new XIAOMI.app.miniLogin;
					h.autoExec()
				} else alert(b.msg)
			};
			return XIAOMI.goodsComments.askQuestion(c, e),
			!1
		})
	},
	goodsAlsoBuy: function() {
		XIAOMI.app.setRecommend({
			obj: $("#goodsAlsoBuy"),
			tmpl: $("#alsobuy-tmpl"),
			url: XIAOMI.GLOBAL_CONFIG.sideBarApiUrl + "/alsobuy/get/id/" + goodsConfig.GoodsId + "/callback/itemRecommend/cid/2",
			limit: 5,
			callback: function() {}
		})
	},
	commonQuesModal: function() {
		var a = {
			getUnitAllHeight: function(a) {
				var b = [];
				return a.each(function() {
					var a = $(this).offset().top;
					b.push(a)
				}),
				b
			}
		},
		b = !!window.ActiveXObject,
		c = b && !window.XMLHttpRequest,
		d = b && !!document.documentMode,
		e = b && !c && !d;
		$("#serQue").click(function() {
			if ($("#modal-faq").find("iframe").attr("src", $("#frame_url").val()), $("#modal-faq").modal("show"), c || e || d) {
				var b = $(this).attr("href"),
				f = b.indexOf("#"),
				g = b.substring(f + 1),
				h = $("iframe").get(0).contentWindow.document.body,
				i = $(h).find(".itemList h1"),
				j = a.getUnitAllHeight(i),
				k = $("iframe").get(0).contentWindow.document.documentElement;
				i.each(function(a) {
					var b = $(this).find("a").attr("name");
					b === g && $(k).scrollTop(j[a])
				})
			}
			return ! 1
		})
	},
	isUseFul: function() {
		$("body").on("click", ".J_use",
		function() {
			var a = $(this).attr("data-id"),
			b = {
				comment_id: a
			},
			c = 0,
			d = this,
			e = function(a) {
				if (0 === a.code) alert("评论成功");
				else if ( - 1001 == a.code) if (XIAOMI.app.cookie("userId")) {
					var f = XIAOMI.GLOBAL_CONFIG.commentApiUrl + "/user/proxy/stop/1",
					g = "<iframe src='" + f + "' width='0' height='0' name='proxy' id='proxy' frameborder='0' scrolling='no'></iframe>";
					$(document.body).append(g),
					$("iframe[name='proxy']").load(function() {
						$("iframe[name='proxy']").remove(),
						c++,
						1 == c && XIAOMI.goodsComments.goodsSetUseful(b, $.proxy(e, d))
					})
				} else {
					var h = new XIAOMI.app.miniLogin;
					h.autoExec()
				} else alert(a.msg)
			};
			XIAOMI.goodsComments.goodsSetUseful(b, e)
		}),
		$("body").on("click", ".J_unuse",
		function() {
			var a = $(this).attr("data-id"),
			b = {
				comment_id: a
			},
			c = 0,
			d = this,
			e = function(a) {
				if (0 === a.code) alert("评论成功");
				else if ( - 1001 == a.code) if (XIAOMI.app.cookie("userId")) {
					var f = XIAOMI.GLOBAL_CONFIG.commentApiUrl + "/user/proxy/stop/1",
					g = "<iframe src='" + f + "' width='0' height='0' name='proxy' id='proxy' frameborder='0' scrolling='no'></iframe>";
					$(document.body).append(g),
					$("iframe[name='proxy']").load(function() {
						$("iframe[name='proxy']").remove(),
						c++,
						1 == c && XIAOMI.goodsComments.goodsSetUnUseful(b, $.proxy(e, d))
					})
				} else {
					var h = new XIAOMI.app.miniLogin;
					h.autoExec()
				} else alert(a.msg)
			};
			XIAOMI.goodsComments.goodsSetUnUseful(b, e)
		})
	},
	judgeClothSize: function() {
		$(".goods-add-cart-btn").on("click",
		function() {
			return "0" === goodsConfig.DataGid && "0" === goodsConfig.IsPackage ? (alert("请选择您要购买的商品" + goodsConfig.GoodsStyle), !1) : void 0
		}),
		$(".goodsStyle").on("click",
		function() {
			var a = $(this).hasClass("disabled");
			if (!a) {
				$(this).parent().addClass("selected").siblings("li").removeClass("selected");
				var b = (parseInt($(this).attr("data-discount"), 0), $(this).attr("data-price")),
				c = $(this).attr("data-market-price"),
				d = $(this).attr("data-is-cos");
				goodsConfig.DataGid = $(this).attr("data-id"),
				goodsConfig.IsCos = d,
				$(".J_mi_marketPrice").html(parseFloat(c) > parseFloat(b) ? c + "元": ""),
				$(".J_mi_goodsPrice").html(b);
				var e = $("#goodsDetailAddCartBtn"),
				f = $("#goodsSubBarAddCartBtn"),
				g = "0" === goodsConfig.NeedChioce ? "false": "true",
				h = "0" === goodsConfig.IsPackage ? "false": "true",
				i = "0" === goodsConfig.DataGid && "1" === goodsConfig.IsPackage ? goodsConfig.GoodsId + "-" + goodsConfig.ScenarioId + "-1": goodsConfig.DataGid,
				j = function() {
					return "true" === g ? XIAOMI.GLOBAL_CONFIG.orderSite + "/item/batchView/bid/" + goodsConfig.GoodsId + "/gid/0/c/1": "true" === h ? XIAOMI.GLOBAL_CONFIG.orderSite + "/cart/add/" + goodsConfig.GoodsId + "-" + goodsConfig.ScenarioId + "-1": XIAOMI.GLOBAL_CONFIG.orderSite + "/cart/add/" + goodsConfig.DataGid + "-" + goodsConfig.ScenarioId + "-1"
				},
				k = j();
				"0" === goodsConfig.IsCos ? $(".goods-add-cart-btn").length > 0 ? (e.attr("href", k).attr("data-gid", i).attr("data-package", g), f.attr("href", k).attr("data-gid", i).attr("data-package", g)) : ($("#goodsDetailBtnBox").find(".goods-over-btn").after('<a href="' + k + '" class="btn btn-primary goods-add-cart-btn" id="goodsDetailAddCartBtn" data-disabled="false" data-gid="' + i + '" data-package="' + g + '"><i class="icon-goods-add"></i>加入购物车</a>'), $("#goodsDetailBtnBox").find(".goods-over-btn").remove(), $("#goodsSubBarBtnBox").html('<a href="' + k + '" class="btn btn-primary goods-add-cart-btn" id="goodsSubBarAddCartBtn" data-disabled="false" data-gid="' + i + '" data-package="' + g + '"><i class="icon-goods-add"></i>加入购物车</a>')) : ($(".goods-add-cart-btn").length > 0 && $(".goods-add-cart-btn").remove(), $(".goods-over-btn").length > 0 && $(".goods-over-btn").remove(), $("#goodsDetailCollectBtn").before('<span class="btn btn-dake goods-over-btn">暂时缺货</a>'), $("#goodsSubBarBtnBox").html('<span class="btn btn-dake goods-over-btn">暂时缺货</a>'))
			}
		})
	},
	clickBigPic: function() {
		var a = this;
		a.cbp_changeWinInit(),
		$(".J_mi_goodsPic_block").on("click", "#J_BigPic",
		function() {
			a.bigpicFlag = !0,
			a.changeProSlidCallback(a.u.SLIDE_INDEX),
			$.proxy(a.cbp_delInsert(), a),
			$.proxy(a.cbp_hideAllDiv(), a),
			$.proxy(a.cbp_addClass(), a),
			$.proxy(a.cbp_close(), a)
		})
	},
	cbp_delInsert: function() {
		var a = this;
		a.PicObj = $("#J_mi_goodsPicBox"),
		$("#J_mi_goodsPicBox").remove(),
		$(".J_mi_layer_goods").html(a.PicObj.clone(!0)),
		$("#J_mi_goodsPicBox").append("<a class='close'><i class='iconfont'>&#xe617;</i></a>"),
		$("#J_mi_goodsPicBox").css("left", a.winLeft).css("top", a.winTop),
		$(".J_mi_layer_goods").find(".goods-pic-box").css("width", a.boxWidth).css("height", a.boxHeight)
	},
	cbp_changeWinInit: function() {
		var a = this;
		a.cbp_initParams(),
		$(window).resize(function() {
			a.cbp_initParams()
		}),
		document.addEventListener && document.addEventListener("DOMMouseScroll",
		function() {
			a.cbp_initParams()
		},
		!1),
		window.onmousewheel = document.onmousewheel = function() {
			a.cbp_initParams()
		}
	},
	cbp_initParams: function() {
		var a = this;
		a.winHeight = $(window).height(),
		$(".J_mi_layer_goods").css("height", a.winHeight + "px"),
		a.scrollTop = $(document).scrollTop(),
		a.winTop = $("#J_mi_goodsPicBox").offset().top - a.scrollTop,
		a.winLeft = $("#J_mi_goodsPicBox").offset().left,
		a.boxWidth = $("#J_mi_goodsPicBox").width(),
		a.boxHeight = $("#J_mi_goodsPicBox").height()
	},
	cbp_addClass: function() {
		var a = this,
		b = function() {
			a.winHeight < 800 ? $(".J_mi_layer_goods").find(".goods-pic-box").addClass("turnBig").css("top", "0px").css("left", "0px").css("height", a.winHeight).css("width", "100%") : $(".J_mi_layer_goods").find(".goods-pic-box").addClass("turnBigSuper").css("top", "0px").css("left", "0px").css("height", a.winHeight).css("width", "100%");
			var b = function() {
				$(".J_mi_layer_goods").find(".icon-slides").show(),
				$(".J_mi_layer_goods").find(".close").show(),
				$(".J_mi_layer_goods").find(".icon-slides").css("height", a.winHeight)
			};
			setTimeout(b, 1e3)
		};
		setTimeout(b, 200)
	},
	cbp_hideAllDiv: function() {
		var a = this;
		a.hideDivArr = [],
		$("body").children("div").each(function(b) {
			var c = $(this).hasClass("hide");
			c || (a.hideDivArr.push(b), $(this).addClass("hide"))
		}),
		$(".J_mi_layer_goods").removeClass("hide")
	},
	cbp_close: function() {
		var a = this;
		$(".J_mi_layer_goods").find(".close").click(function() {
			$(this).hide(),
			a.bigpicFlag = !1,
			$("#J_mi_goodsPicBox").find(".icon-slides").hide(),
			$("#J_mi_goodsPicBox").removeClass("turnBig").removeClass("turnBigSuper").css("left", a.winLeft).css("top", a.winTop).css("width", a.boxWidth).css("height", a.boxHeight);
			var b = function() {
				a.cbp_showAllDiv(),
				a.changeProSlidCallback(a.u.SLIDE_INDEX),
				$("html,body").animate({
					scrollTop: a.scrollTop + "px"
				},
				0)
			};
			setTimeout(b, 1e3)
		})
	},
	cbp_showAllDiv: function() {
		var a = this;
		for (var b in a.hideDivArr) {
			var c = a.hideDivArr[b];
			$("body").children("div").eq(c).removeClass("hide")
		}
		$(".J_mi_layer_goods").addClass("hide"),
		$("#J_mi_goodsPicBox").remove(),
		$(".J_mi_goodsPic_block").html(a.PicObj)
	}
},
$(function() {
	XIAOMI.goodsDetail.init()
});