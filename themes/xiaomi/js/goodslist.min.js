XIAOMI.namespace("goodsList"),XIAOMI.goodsList={ajaxItemLoader:{defaults:{currentPage:1,requestUrl:null,requestUrlApend:null,morePage:!0,callback:function(){}},globalVars:{requestPage:null,loadStarted:!1,morePage:!0},getScrollThreshold:function(a){var b,c;return b=a.find("li").last(),0===b.size()?0:c=b.offset().top+b.height()},getCurrentScrollOffset:function(a){var b,c;return b=a.get(0)===window?a.scrollTop():a.offset().top,c=a.height(),b+c},loadItems:function(a,b,c){var d=this,e=$('<li class="notice"><span class="loading">Loading</span></li>'),f=doT.template($("#itemTemplate").html());a.append(e),null===d.globalVars.requestPage?d.globalVars.requestPage=b.currentPage+1:d.globalVars.requestPage+=1,$.ajax({url:b.requestUrl+d.globalVars.requestPage+b.requestUrlApend,type:"get",dataType:"jsonp",jsonp:"jsonpcallback",jsonpCallback:"items",cache:!0,error:function(){e.text("加载失败，请刷新页面后再试。")},success:function(d){e.remove(),0===d.type&&d.data.product.length>0?(a.append(f(d.data)),b.callback(),void 0!==c&&c(d)):(e.text("加载错误，请稍后再试。"),b.callback(),void 0!==c&&c(d))}})},init:function(a,b){var c,d=this,e=0;c=$.extend({},d.defaults,b),d.globalVars.morePage=c.morePage,$(window).on("scroll",function(){a.height()-(d.getCurrentScrollOffset($(window))-a.offset().top)<=-100&&d.globalVars.loadStarted===!1&&d.globalVars.morePage===!0&&4>e&&(d.loadItems(a,c,function(a){$(".xm-pagenavi").html(a.data.pager),d.globalVars.loadStarted=!1,d.globalVars.morePage=a.data.more}),d.globalVars.loadStarted=!0,e+=1)})}}};